<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="author" content="ZXing for JS" />

	<title>移动端扫描测试</title>

<body>
	<main class="wrapper" style="padding-top: 2em">
		<section class="container" id="demo-content">
			<h1 class="title">Scan 1D/2D Code from Video Camera</h1>
			<div>
				<button style="padding: 10px;" id="startButton">拉起摄像头，开启持续扫描</button>
				<button style="padding: 10px;color:green;" id="showVideo">扫描窗口展示</button>
			</div>
			<div>
				<video id="video" width="300" height="200"
					style="margin:10px 0 0;border: 1px solid gray;position: fixed;top: 100%;"></video>
			</div>
			<div id="sourceSelectPanel" style="display: none">
				<label for="sourceSelect">Change video source:</label>
				<select id="sourceSelect" style="max-width: 400px"></select>
			</div>
			<div style="height: 300px;overflow:auto;" id="result"></div>
		</section>
	</main>

	<script type="text/javascript" src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
	<script type="text/javascript">
		window.addEventListener('load', function () {
			let selectedDeviceId;
			const codeReader = new ZXing.BrowserMultiFormatReader();
			codeReader
				.listVideoInputDevices()
				.then((videoInputDevices) => {
					console.log('videoInputDevices: ', videoInputDevices);
					let selectedDeviceId = videoInputDevices[0].deviceId;
					if (videoInputDevices.length > 1) {
						selectedDeviceId = videoInputDevices[1].deviceId;
					}

					const scan = () => {
						codeReader.decodeFromVideoDevice(
							selectedDeviceId,
							'video',
							(result, err) => {
								if (result) {
									console.log(result);
									document.getElementById('result').innerHTML = `<p style="margin:10px 0;padding:5px;border:1px solid;">扫描结果：${result.text} | 扫描时间：${new Date()}</p>${document.getElementById('result').innerHTML}`;
								}
								if (err && !(err instanceof ZXing.NotFoundException)) {
									console.error(err);
									document.getElementById('result').textContent = err;
								}
							}
						);
						console.log(
							`Started continous decode from camera with id ${selectedDeviceId}`
						);
					};

					document
						.getElementById('startButton')
						.addEventListener('click', scan);

					const btnVideo = document.getElementById('showVideo');
					btnVideo.addEventListener('click', () => {
						const video = document.querySelector('video');
						if (video.style.position === 'fixed') {
							video.style.position = 'static';
							btnVideo.style.color = 'green';
							btnVideo.textContent = '切换扫描窗口 当前：展示';
						} else {
							video.style.position = 'fixed';
							btnVideo.style.color = 'red';
							btnVideo.textContent = '切换扫描窗口 当前：隐藏';
						}
					})
				})
				.catch((err) => {
					console.error(err);
				});
		});
	</script>
</body>

</html>